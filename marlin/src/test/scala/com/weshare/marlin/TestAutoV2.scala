package com.weshare.marlin

import com.weshare.marlin.auto.AutoMainV2
import com.weshare.marlin.logging.WeshareLogging
import com.weshare.marlin.model.conf2.{FieldConf2, MaskConf2, TaskConf2}
import com.weshare.marlin.utils.CommonUtils
import org.apache.spark.sql.Row

import scala.util.parsing.json.JSONObject

object TestAutoV2 extends WeshareLogging {
  def main(args: Array[String]): Unit = {
//    val jsonStr = "{\"feedModels\":[{\"id\":\"\",\"created_time\":\"2018-11-28 10:26:36\",\"message\":\"Mak lee taoh beih\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-11-09 19:51:37\",\"message\":null,\"story\":null,\"caption\":\"pivot.one\",\"description\":null,\"status_type\":\"shared_story\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-11-03 16:10:14\",\"message\":null,\"story\":null,\"caption\":\"id.meowshareid22.com\",\"description\":\"Apa 6 hal yg nggak akan pernah berubah dari kamu?\",\"status_type\":\"shared_story\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-11-03 16:08:42\",\"message\":null,\"story\":null,\"caption\":\"id.meowshareid22.com\",\"description\":\"Apa yg wajahmu katakan tentang kamu?\",\"status_type\":\"shared_story\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-09-15 02:12:08\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[{\"name\":\"Lek Agunk\",\"id\":\"\",\"created_time\":null,\"profile_type\":null}]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-08-15 17:28:24\",\"message\":\"bismillah 17-09 :innocent::innocent:\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"mobile_status_update\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-08-04 11:05:57\",\"message\":\"alhamdulilaah ya allahh....\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"mobile_status_update\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-07-29 21:00:35\",\"message\":\"a dream doesn't maybe become reality through magic ,\\n but it a dream can become reality with  determination , hard work and pray :innocent:\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"mobile_status_update\",\"likes\":{\"data\":[{\"name\":\"Lek Agunk\",\"id\":\"\",\"created_time\":null,\"profile_type\":null}]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-07-29 20:47:19\",\"message\":\"I believe when God placed me at the beginning of this journey. he is the one who will lead me to the end. I believe god will not take me so far only for failure !! I believe it :innocent:\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"mobile_status_update\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-07-26 00:20:00\",\"message\":\"cowok itu bukan HP yang dipilih pilih karena kelengkapan fiturnya dan merek populernya\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"mobile_status_update\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-07-23 10:11:29\",\"message\":\"ya allahh,,,\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"mobile_status_update\",\"likes\":{\"data\":[{\"name\":\"Lek Agunk\",\"id\":\"\",\"created_time\":null,\"profile_type\":null}]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-07-16 05:27:20\",\"message\":\"yang di harapkan teryata tidak sesuai apa yang aku harapkan\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"mobile_status_update\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-07-15 22:26:03\",\"message\":\"CTI JOGJA\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[{\"name\":\"Lek Agunk\",\"id\":\"\",\"created_time\":null,\"profile_type\":null}]},\"comments\":{\"data\":[{\"created_time\":\"2018-07-19 16:42:28\",\"message\":\"siap kakak\",\"id\":\"\"}]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-06-02 12:23:56\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-06-02 12:21:52\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-05-30 18:23:39\",\"message\":\"Sancok kah :sleepy:\",\"story\":null,\"caption\":\"id.meow-share.com\",\"description\":\"Berani buat share apapun hasilmu?\",\"status_type\":\"shared_story\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-05-30 18:22:26\",\"message\":null,\"story\":null,\"caption\":\"id.meow-share.com\",\"description\":\"Berani buat share apapun hasilmu?\",\"status_type\":\"shared_story\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-05-30 18:16:38\",\"message\":\":sunglasses:\",\"story\":null,\"caption\":\"id.meow-share.com\",\"description\":\"Berani buat share apapun hasilmu?\",\"status_type\":\"shared_story\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-05-30 18:14:12\",\"message\":\"Agoh abinih 2019 :smiley:\",\"story\":null,\"caption\":\"id.meow-share.com\",\"description\":\"Berani buat share apapun hasilmu?\",\"status_type\":\"shared_story\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-05-30 18:13:07\",\"message\":\"Parak roco weh pak ustadz riah :unamused::smirk::joy:\",\"story\":null,\"caption\":\"id.meow-share.com\",\"description\":\"Berani buat share apapun hasilmu?\",\"status_type\":\"shared_story\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-05-30 18:11:50\",\"message\":\"Betul jiah\",\"story\":null,\"caption\":\"id.meow-share.com\",\"description\":\"Berani buat share apapun hasilmu?\",\"status_type\":\"shared_story\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-05-30 18:10:56\",\"message\":\"Lok nyaman dibik :smiley:\",\"story\":null,\"caption\":\"id.meow-share.com\",\"description\":\"Berani buat share apapun hasilmu?\",\"status_type\":\"shared_story\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-05-30 17:58:46\",\"message\":null,\"story\":null,\"caption\":\"id.meow-share.com\",\"description\":\"Berani buat share apapun hasilmu?\",\"status_type\":\"shared_story\",\"likes\":{\"data\":[{\"name\":\"Lek Agunk\",\"id\":\"\",\"created_time\":null,\"profile_type\":null}]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-04-23 17:46:47\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-04-23 00:00:40\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-04-22 13:20:28\",\"message\":\"Melihat teman saya onani :rolling_on_the_floor_laughing:\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"mobile_status_update\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-04-22 12:19:50\",\"message\":\"God ... I believe in choice of god :innocent:\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-04-07 04:41:43\",\"message\":\"Astagfirullah makin dewasa semakin nakal ,,\\n tambah hari tambah menggila semoga gak dapat istri semacam dia lagi amin :innocent:\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"mobile_status_update\",\"likes\":{\"data\":[{\"name\":\"Lek Agunk\",\"id\":\"\",\"created_time\":null,\"profile_type\":null}]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-02-24 08:44:37\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-02-23 20:10:40\",\"message\":\"I do not care what they say about your ugliness :blush:, the things I know about you, you will always be the best for me and I am sure of it :wink:, thank God for everything and thank you for giving me the perfect person for my life.:kissing_heart::angel:\",\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-02-22 11:31:56\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[{\"created_time\":\"2018-02-22 11:44:15\",\"message\":\"Demmang kak\",\"id\":\"\"},{\"created_time\":\"2018-02-22 11:46:29\",\"message\":\"Take rest aku kak\",\"id\":\"\"},{\"created_time\":\"2018-02-22 11:49:41\",\"message\":\"Cti ajah kak lebih srek aku\",\"id\":\"\"},{\"created_time\":\"2018-02-22 12:20:49\",\"message\":\"Iya kak pola pas kading hedeh kak nyaman\",\"id\":\"\"},{\"created_time\":\"2018-02-22 12:32:48\",\"message\":\"Siap pak bos\",\"id\":\"\"}]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-02-04 09:25:28\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-01-26 03:59:54\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2018-01-22 12:12:46\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2015-02-16 00:46:20\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2012-10-29 02:44:43\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2012-10-29 02:17:09\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2011-11-13 13:59:34\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"2011-11-13 12:36:54\",\"message\":null,\"story\":null,\"caption\":null,\"description\":null,\"status_type\":\"added_photos\",\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null},{\"id\":\"\",\"created_time\":\"1993-05-05 07:00:00\",\"message\":null,\"story\":\"Lek Agunk added a life event from May 5, 1993: Born on May 5, 1993.\",\"caption\":\"Born on May 5, 1993\",\"description\":null,\"status_type\":null,\"likes\":{\"data\":[]},\"comments\":{\"data\":[]},\"fname\":null,\"backdated_time\":null,\"from_user\":null,\"full_picture\":null}],\"page_info\":{\"total_size\":\"40\",\"page_index\":\"0\",\"page_size\":\"100\",\"page_cnt\":\"40\"},\"crawlerTime\":1546631390559,\"sptype\":\"facebook.feedModels\",\"userId\":\"39628c48ab3f4ad28bd2fcc2566cfced\",\"idcardNo\":\"0062186087859928228487\",\"data_version\":\"1\",\"source\":\"借款2.0\",\"tokenId\":\"962378cf7668082bbf6334bd611b8ea5\",\"platform\":\"facebook\",\"record_gid\":\"962378cf7668082bbf6334bd611b8ea5\",\"channel\":\"inadmall\",\"channelSub\":\"201\",\"clientId\":null,\"showType\":null,\"ch\":null,\"total_num\":4,\"userGid\":null,\"s_path\":\"/data/bigdata/facebook/facebook.1.20190105.log\",\"s_line_num\":3,\"s_host\":\"yjdl-as-10b\",\"s_site\":\"yjdl\",\"s_forwarder\":\"yjdl-as-10b,1546631411,yjdl-op-01,1546631413,hbc-op-01,1546631416,tai-es-04,1546631418,tai-bg-08,1546631419\",\"time\":\"2019-01-05T03:50:11+08:00\",\"tag\":\"spider.facebook\"}"
    val jsonStr = "{\"globalType\":\"black\",\"sptype\":\"xybg.black.gf\",\"record_gid\":\"5cf6925a38f047a9a749015c8bae8297_1\",\"user_gid\":\"21667da7-2bba-4e52-9c6d-e1bf31b57c4c\",\"order_id\":\"31206627480522199040\",\"channel\":\"1030100280\",\"bizType\":\"zxmc\",\"name\":\"王海军\",\"phone\":\"13832920744\",\"idcardNo\":\"130227197409085014\",\"totalItems\":7,\"currentItem\":5,\"crawler_time\":1549957654464,\"report\":{\"type\":1,\"identity\":\"130227197409085014\",\"name\":\"王海军\",\"cases\":[{\"type\":0,\"caseID\":\"（2018）冀02执12356号\",\"caseCreateTime\":\"2018-06-10T16:00:00.000Z\",\"courtName\":\"唐山市中级人民法院\",\"province\":\"\",\"executionTarget\":\"64800\"}]},\"s_path\":\"/data/bigdata/xybgblack/black.20190212.log\",\"s_line_num\":473,\"s_host\":\"tai-as-sx-53\",\"s_site\":\"tai\",\"s_forwarder\":\"tai-as-sx-53,1549957654,tai-es-04,1549957655,tai-bg-07,1549957656\",\"tag\":\"spider.xybgblack\",\"time\":\"2019-02-12T15:47:34+08:00\"}"

    val fieldConfs = Array(
      new FieldConf2("ugid", "$.userId"),
      new FieldConf2("sptype", "$.sptype"),
      new FieldConf2("idcard", "$.idcardNo"),
      new FieldConf2("dm.data_id", "$..likes.data[*].id")
    )

    //    val packList = Array("$.page_info.*", "$.feedModels")
    val packList = Array("$.page_info.*", "$.feedModels.*", "$..likes.data.*", "$.*")

    val maskList = Array(
      new MaskConf2("$.idcardNo", "idcard")
    )

    val tasks = Array(
      new TaskConf2(null, null, fieldConfs, packList, maskList)
    )

    logger.info(CommonUtils.objToJson(tasks))

    val schemas = Array("ugid", "sptype", "idcard", "dm")

    val rows = AutoMainV2.process(jsonStr, schemas, tasks)

    rows.foreach { row =>
      logger.info(CommonUtils.objToJson(row))
    }
  }

  def convertRowToJSON(row: Row): String = {
    val m = row.getValuesMap(row.schema.fieldNames)
    JSONObject(m).toString()
  }
}
